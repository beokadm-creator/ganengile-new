rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ==================== Helper Functions ====================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ==================== Config Collections (Read-Only) ====================

    match /config_stations/{stationId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /config_travel_times/{timeId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /config_express_trains/{trainId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /config_congestion/{congestionId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /config_algorithm_params/{documentId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ==================== Users Collection ====================

    match /users/{userId} {
      // 읽기: 본인 또는 인증된 사용자
      allow read: if isOwner(userId) || isAuthenticated();

      // 쓰기: 본인만
      allow write: if isOwner(userId);

      // 삭제: 본인만
      allow delete: if isOwner(userId);
    }

    // ==================== Routes Collection ====================

    match /routes/{routeId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 본인만
      allow write: if isOwner(resource.data.userId);

      // 삭제: 본인만
      allow delete: if isOwner(resource.data.userId);
    }

    // ==================== Requests Collection ====================

    match /requests/{requestId} {
      // 읽기: 본인(gller/giller) 또는 관리자
      allow read: if isAuthenticated() &&
                  (isOwner(resource.data.userId) ||
                   isOwner(resource.data.gllerId) ||
                   isOwner(resource.data.gillerId));

      // 쓰기: 본인만
      allow write: if isOwner(resource.data.userId);

      // 삭제: 본인만
      allow delete: if isOwner(resource.data.userId);
    }

    // ==================== Matches Collection ====================

    match /matches/{matchId} {
      // 읽기: 관련된 사용자 (requester, gller/giller)
      allow read: if isAuthenticated() &&
                  (isOwner(resource.data.userId) ||
                   isOwner(resource.data.gllerId) ||
                   isOwner(resource.data.gillerId));

      // 쓰기: 시스템 또는 본인
      allow write: if isOwner(resource.data.userId);

      // 삭제: 시스템만
      allow delete: if false;
    }

    // ==================== Deliveries Collection ====================

    match /deliveries/{deliveryId} {
      // 읽기: gller/giller 또는 requester
      allow read: if isAuthenticated() &&
                  (isOwner(resource.data.gllerId) ||
                   isOwner(resource.data.gillerId) ||
                   isOwner(resource.data.userId));

      // 쓰기: gller/giller만
      allow write: if isOwner(resource.data.gllerId) ||
                   isOwner(resource.data.gillerId);

      // 삭제: 시스템만
      allow delete: if false;
    }

    // ==================== Ratings Collection ====================

    match /ratings/{ratingId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 본인(fromUserId)만
      allow write: if isOwner(resource.data.fromUserId);

      // 삭제: 시스템만
      allow delete: if false;
    }

    // ==================== Penalties Collection ====================

    match /penalties/{penaltyId} {
      // 읽기: 본인만
      allow read: if isOwner(resource.data.userId);

      // 쓰기: 시스템만 (Admin SDK)
      allow write: if false;

      // 삭제: 시스템만
      allow delete: if false;
    }

    // ==================== Chats Collection ====================

    match /chats/{chatId} {
      // 읽기: 참여자만
      allow read: if isAuthenticated() &&
                  (request.auth.uid in resource.data.participants);

      // 쓰기: 참여자만
      allow write: if isAuthenticated() &&
                   (request.auth.uid in resource.data.participants);

      // 삭제: 참여자 모두 or 시스템
      allow delete: if false;
    }

    // ==================== Messages Collection ====================

    match /chats/{chatId}/messages/{messageId} {
      // 읽기: 채팅방 참여자만
      allow read: if isAuthenticated();
      // 메시지는 상위 채팅방 권한을 따름

      // 쓰기: 참여자만
      allow write: if isAuthenticated();
      // 메시지는 상위 채팅방 권한을 따름

      // 삭제: 발신자만
      allow delete: if isOwner(resource.data.senderId);
    }

    // ==================== B2B Collections ====================

    match /b2b_requests/{requestId} {
      // 읽기: B2B 회사 또는 길러
      allow read: if isAuthenticated() &&
                  (isOwner(resource.data.companyId) ||
                   request.auth.uid in resource.data.availableGillers);

      // 쓰기: B2B 회사만
      allow write: if isOwner(resource.data.companyId);

      // 삭제: B2B 회사만
      allow delete: if isOwner(resource.data.companyId);
    }

    match /b2b_gillers/{gillerId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 본인(gller/giller)만
      allow write: if isOwner(gillerId);

      // 삭제: 본인만
      allow delete: if isOwner(gillerId);
    }

    match /b2b_settlements/{settlementId} {
      // 읽기: B2B 회사만
      allow read: if isOwner(resource.data.companyId);

      // 쓰기: 시스템만 (Admin SDK)
      allow write: if false;

      // 삭제: 시스템만
      allow delete: if false;
    }

    // ==================== Lockers Collection ====================

    match /lockers/{lockerId} {
      // 읽기: 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 시스템만 (Admin SDK)
      allow write: if false;

      // 삭제: 시스템만
      allow delete: if false;
    }
  }
}
