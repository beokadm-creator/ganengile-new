name: Deploy to Firebase

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deploy target'
        required: true
        type: choice
        options:
          - firestore
          - hosting
          - functions
          - all
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: ðŸ”§ Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: ðŸ” Setup Firebase
        run: |
          npm install -g firebase-tools
          echo "$FIREBASE_SERVICE_ACCOUNT" > service-account.json
          firebase projects:use ganengile
      
      - name: ðŸš€ Deploy to Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          TARGET=${{ github.event.inputs.target }}
          case $TARGET in
            firestore)
              firebase deploy --only firestore:rules --project ganengile
              ;;
            hosting)
              firebase deploy --only hosting --project ganengile
              ;;
            functions)
              firebase deploy --only functions --project ganengile
              ;;
            all)
              firebase deploy --project ganengile
              ;;
          esac
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: rm -f service-account.json

  pre-flight-check:
    name: Pre-flight Check
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: âœ… Run pre-flight check
        run: |
          chmod +x scripts/pre-flight-check.sh
          ./scripts/pre-flight-check.sh
